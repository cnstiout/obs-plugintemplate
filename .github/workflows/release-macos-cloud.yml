name: macOS Cloud Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (example: v0.1.0)"
        required: true
        default: "v0.1.0"
      publish_release:
        description: "Publish GitHub Release"
        required: true
        default: true
        type: boolean
      draft:
        description: "Create release as draft"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"
      CMAKE_BUILD_PARALLEL_LEVEL: "4"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          if ! brew list cmake >/dev/null 2>&1; then
            brew install cmake
          fi
          if ! brew list opencv >/dev/null 2>&1; then
            brew install opencv
          fi

      - name: Toolchain Versions
        shell: bash
        run: |
          set -euo pipefail
          sw_vers
          xcodebuild -version
          cmake --version
          brew --version
          brew list --versions opencv

      - name: Configure CMake (macOS)
        shell: bash
        run: |
          set -euo pipefail
          OPENCV_DIR="$(brew --prefix opencv)/lib/cmake/opencv4"
          cmake --preset macos \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCODESIGN_IDENTITY=- \
            -DOpenCV_DIR="$OPENCV_DIR"

      - name: Build
        run: cmake --build --preset macos --config RelWithDebInfo --parallel

      - name: Install
        run: cmake --install build_macos --config RelWithDebInfo --prefix dist_macos

      - name: Inspect Install Tree
        shell: bash
        run: |
          set -euo pipefail
          find dist_macos -maxdepth 5 -print

      - name: Package Assets
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.inputs.tag }}"
          SAFE_TAG="${TAG#v}"
          OUT_DIR="release-assets"
          mkdir -p "$OUT_DIR"

          PLUGIN_PATH="$(find dist_macos -type d -name '*.plugin' | head -n 1)"
          if [[ -z "${PLUGIN_PATH:-}" ]]; then
            echo "No .plugin bundle found under dist_macos"
            find dist_macos -maxdepth 8 -print || true
            exit 1
          fi

          ditto -c -k --keepParent "$PLUGIN_PATH" "$OUT_DIR/obs-face-emotion-filter-${SAFE_TAG}-macos-arm64-plugin.zip"

          PKG_PATH="$(find dist_macos -type f -name '*.pkg' | head -n 1)"
          if [[ -n "${PKG_PATH:-}" ]]; then
            cp "$PKG_PATH" "$OUT_DIR/"
          fi

          (
            cd "$OUT_DIR"
            shasum -a 256 * > SHA256SUMS.txt
          )

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-assets
          path: release-assets/*
          if-no-files-found: error

      - name: Publish GitHub Release
        if: ${{ github.event.inputs.publish_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: OBS Face Emotion Filter ${{ github.event.inputs.tag }}
          draft: ${{ github.event.inputs.draft }}
          generate_release_notes: true
          files: |
            release-assets/*
